<div class="form-list-container">
  <!-- En-tête avec navigation -->
  <div class="header">
    <div class="header-title">
      <mat-icon class="header-icon">folder</mat-icon>
      <h1>Mes formulaires</h1>
    </div>

    <div class="header-controls">
      <button mat-raised-button color="primary" (click)="createNewForm()" class="create-btn">
        <mat-icon>add</mat-icon>
        Créer un formulaire
      </button>

      <button
        mat-raised-button
        color="accent"
        (click)="goToPublishedForms(filteredPublishedForms[0])"
        [disabled]="filteredPublishedForms.length === 0"
        class="fill-btn">
        <mat-icon>assignment</mat-icon>
        Remplir le formulaire publié
      </button>

      <div class="search-container">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Rechercher</mat-label>
          <input matInput
                 [(ngModel)]="searchTerm"
                 (input)="onSearch()"
                 placeholder="Nom, description...">
          <mat-icon matSuffix>search</mat-icon>
          <button matSuffix
                  mat-icon-button
                  *ngIf="searchTerm"
                  (click)="clearSearch()">
            <mat-icon>close</mat-icon>
          </button>
        </mat-form-field>
      </div>
    </div>
  </div>

  <!-- Statistiques rapides -->
  <div class="stats-row">
    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-number">{{forms.length}}</div>
        <div class="stat-label">Total formulaires</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-number">{{draftForms.length}}</div>
        <div class="stat-label">Brouillons</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-content>
        <div class="stat-number">{{publishedForms.length}}</div>
        <div class="stat-label">Publiés</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Loading state -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>Chargement des formulaires...</p>
  </div>

  <!-- Liste des formulaires -->
  <div class="forms-content" *ngIf="!loading">

    <!-- Section Brouillons -->
    <div class="forms-section" *ngIf="filteredDraftForms.length > 0">
      <div class="section-header">
        <div class="section-title">
          <mat-icon>edit</mat-icon>
          <h2>Brouillons ({{filteredDraftForms.length}})</h2>
        </div>
        <p class="section-description">Formulaires en cours de création</p>
      </div>

      <div class="forms-list">
        <div *ngFor="let form of filteredDraftForms" class="form-row">
          <div class="form-name">{{form.name}}</div>
          <div class="form-count">{{getFormFieldsCount(form)}}</div>
          <div class="form-actions">
<span
  [matTooltip]="!canEdit(form) ? 'Seul le créateur peut modifier ce formulaire' : ''"
  matTooltipPosition="above">
  <button
    mat-raised-button
    class="action-btn btn-modify"
    (click)="editForm(form.id!)"
    [disabled]="!canEdit(form)">
    <mat-icon>edit</mat-icon>
    Modifier
  </button>
</span>




            <button mat-raised-button class="action-btn btn-preview" (click)="previewForm(form.id!)">
              <mat-icon>visibility</mat-icon>
              Aperçu
            </button>
            <button mat-raised-button class="action-btn btn-publish" (click)="publishForm(form)">
              <mat-icon>publish</mat-icon>
              Publier
            </button>
            <button mat-icon-button class="action-btn btn-more" [matMenuTriggerFor]="draftMenu">
              <mat-icon>more_vert</mat-icon>
            </button>

<mat-menu #draftMenu="matMenu">
  <!-- ✅ BOUTON TÉLÉCHARGER WORD avec logique d'autorisation -->
  <span [matTooltip]="getDownloadAccessMessage(form)"
        matTooltipPosition="left"
        [matTooltipDisabled]="canDownloadForm(form)">
    <button
      mat-menu-item
      (click)="downloadFormAsWord(form)"
      [disabled]="!canDownloadForm(form)"
      [class.disabled-menu-item]="!canDownloadForm(form)">
      <mat-icon [class.disabled-icon]="!canDownloadForm(form)">download</mat-icon>
      Télécharger en Word
    </button>
  </span>

  <button mat-menu-item (click)="deleteForm(form.id!)" class="delete-action">
    <mat-icon>delete</mat-icon>
    Supprimer
  </button>
</mat-menu>
          </div>
        </div>
      </div>
    </div>

    <!-- Section Publiés -->
    <div class="forms-section" *ngIf="filteredPublishedForms.length > 0">
      <div class="section-header">
        <div class="section-title">
          <mat-icon>publish</mat-icon>
          <h2>Publiés ({{filteredPublishedForms.length}})</h2>
        </div>
        <p class="section-description">Formulaires disponibles pour remplissage</p>
      </div>

      <div class="forms-list">
        <div *ngFor="let form of filteredPublishedForms" class="form-row">
          <div class="form-name">{{form.name}}</div>
          <div class="form-count">{{getFormFieldsCount(form)}}</div>
          <div class="form-actions">
            <button mat-raised-button class="action-btn btn-submissions" (click)="viewSubmissions(form)">
              <mat-icon>analytics</mat-icon>
              Soumissions
            </button>
            <button mat-raised-button class="action-btn btn-fill" (click)="fillForm(form)">
              <mat-icon>edit</mat-icon>
              Remplir
            </button>
            <button mat-raised-button class="action-btn btn-settings" (click)="editForm(form.id!)">
              <mat-icon>settings</mat-icon>
              Modifier
            </button>
            <button mat-icon-button class="action-btn btn-more" [matMenuTriggerFor]="publishedMenu">
              <mat-icon>more_vert</mat-icon>
            </button>

<mat-menu #publishedMenu="matMenu">
  <button mat-menu-item (click)="copyPublicUrl(form)">
    <mat-icon>link</mat-icon>
    Copier URL publique
  </button>
<span [matTooltip]="form.isInLibrary ? 'Formulaire déjà dans la bibliothèque' : 'Partager ce formulaire dans la bibliothèque'"
        matTooltipPosition="left">
    <button
      mat-menu-item
      (click)="shareToLibrary(form)"
      [disabled]="form.isInLibrary || !canEdit(form)"
      [class.disabled-menu-item]="form.isInLibrary || !canEdit(form)">
      <mat-icon [class.disabled-icon]="form.isInLibrary">library_add</mat-icon>
      {{form.isInLibrary ? 'Déjà dans la bibliothèque' : 'Partager vers bibliothèque'}}
    </button>
  </span>
  <!-- ✅ BOUTON TÉLÉCHARGER WORD avec logique d'autorisation -->
  <span [matTooltip]="getDownloadAccessMessage(form)"
        matTooltipPosition="left"
        [matTooltipDisabled]="canDownloadForm(form)">
    <button
      mat-menu-item
      (click)="downloadFormAsWord(form)"
      [disabled]="!canDownloadForm(form)"
      [class.disabled-menu-item]="!canDownloadForm(form)">
      <mat-icon [class.disabled-icon]="!canDownloadForm(form)">download</mat-icon>
      Télécharger en Word
    </button>
  </span>

  <button mat-menu-item (click)="deleteForm(form.id!)" class="delete-action">
    <mat-icon>delete</mat-icon>
    Supprimer
  </button>
</mat-menu>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty state -->
    <div class="empty-state" *ngIf="forms.length === 0">
      <mat-card class="empty-card">
        <mat-card-content>
          <div class="empty-content">
            <mat-icon class="empty-icon">assignment</mat-icon>
            <h2>Aucun formulaire</h2>
            <p>Créez votre premier formulaire pour commencer à collecter des données</p>
            <button mat-raised-button color="primary" (click)="createNewForm()" class="empty-cta">
              <mat-icon>add</mat-icon>
              Créer mon premier formulaire
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Search results empty -->
    <div class="empty-state" *ngIf="forms.length > 0 && filteredDraftForms.length === 0 && filteredPublishedForms.length === 0">
      <mat-card class="empty-card">
        <mat-card-content>
          <div class="empty-content">
            <mat-icon class="empty-icon">search_off</mat-icon>
            <h2>Aucun résultat</h2>
            <p>Aucun formulaire ne correspond à votre recherche "{{searchTerm}}"</p>
            <button mat-raised-button (click)="clearSearch()">
              <mat-icon>clear</mat-icon>
              Effacer la recherche
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
