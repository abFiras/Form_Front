<div class="dynamic-field" [class.preview-mode]="isPreview">
  <!-- Edit Mode -->
  <div class="field-editor" *ngIf="editMode && !isPreview">
    <form [formGroup]="editForm">
      <mat-form-field appearance="outline">
        <mat-label>Label</mat-label>
        <input matInput formControlName="label">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Placeholder</mat-label>
        <input matInput formControlName="placeholder">
      </mat-form-field>

      <mat-checkbox formControlName="required">Required</mat-checkbox>

      <mat-form-field appearance="outline" *ngIf="hasOptions()">
        <mat-label>Options (one per line, format: label:value)</mat-label>
        <textarea matInput formControlName="options" rows="4"></textarea>
      </mat-form-field>

      <div class="editor-actions">
        <button mat-button (click)="saveChanges()" type="button">Save</button>
        <button mat-button (click)="toggleEdit()" type="button">Cancel</button>
      </div>
    </form>
  </div>

  <!-- Field Display -->
  <div class="field-display" *ngIf="!editMode"  [formGroup]="formGroup">
    <div class="field-controls" *ngIf="!isPreview">
      <button mat-icon-button (click)="toggleEdit()" class="edit-btn">
        <mat-icon>edit</mat-icon>
      </button>
      <button mat-icon-button (click)="remove()" class="delete-btn" color="warn">
        <mat-icon>delete</mat-icon>
      </button>
    </div>

    <!-- Text Input -->
    <mat-form-field appearance="outline" *ngIf="field.type === 'text'" class="full-width">
      <mat-label>{{field.label}}</mat-label>
      <input matInput
             [placeholder]="field.placeholder || ''"
             [formControlName]="field.fieldName"
             [required]="field.required">
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </mat-form-field>

    <!-- Textarea -->
    <mat-form-field appearance="outline" *ngIf="field.type === 'textarea'" class="full-width">
      <mat-label>{{field.label}}</mat-label>
      <textarea matInput
                [placeholder]="field.placeholder || ''"
                [formControlName]="field.fieldName"
                [required]="field.required"
                rows="4"></textarea>
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </mat-form-field>

    <!-- Email -->
    <mat-form-field appearance="outline" *ngIf="field.type === 'email'" class="full-width">
      <mat-label>{{field.label}}</mat-label>
      <input matInput
             type="email"
             [placeholder]="field.placeholder || ''"
             [formControlName]="field.fieldName"
             [required]="field.required">
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('email')">
        Please enter a valid email
      </mat-error>
    </mat-form-field>

    <!-- Number -->
    <mat-form-field appearance="outline" *ngIf="field.type === 'number'" class="full-width">
      <mat-label>{{field.label}}</mat-label>
      <input matInput
             type="number"
             [placeholder]="field.placeholder || ''"
             [formControlName]="field.fieldName"
             [required]="field.required">
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </mat-form-field>

    <!-- Date -->
    <mat-form-field appearance="outline" *ngIf="field.type === 'date'" class="full-width">
      <mat-label>{{field.label}}</mat-label>
      <input matInput
             [matDatepicker]="picker"
             [formControlName]="field.fieldName"
             [required]="field.required">
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </mat-form-field>

    <!-- DateTime -->
    <mat-form-field appearance="outline" *ngIf="field.type === 'datetime'" class="full-width">
      <mat-label>{{field.label}}</mat-label>
      <input matInput
             type="datetime-local"
             [placeholder]="field.placeholder || ''"
             [formControlName]="field.fieldName"
             [required]="field.required">
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </mat-form-field>

    <!-- Slider -->
    <div *ngIf="field.type === 'slider'" class="slider-field">
      <label class="field-label">{{field.label}}</label>
      <mat-slider min="0" max="100" step="1" discrete>
        <input matSliderThumb [formControlName]="field.fieldName" [required]="field.required">
      </mat-slider>
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </div>

    <!-- Geolocation -->
    <div *ngIf="field.type === 'geolocation'" class="geolocation-field">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{field.label}}</mat-label>
        <input matInput
               [placeholder]="field.placeholder || 'Coordonnées GPS'"
               [formControlName]="field.fieldName"
               [required]="field.required"
               readonly>
        <button mat-icon-button matSuffix type="button" (click)="getLocation()">
          <mat-icon>my_location</mat-icon>
        </button>
      </mat-form-field>
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </div>
<!-- Ajoutez cette section dans votre dynamic-field.component.html existant -->

<!-- Remplacez votre bloc externe par ceci -->
<!-- External List Field - Utiliser *ngIf au lieu de *ngSwitchCase -->
<div *ngIf="field.type === 'external-list'" class="field-wrapper">
  <app-external-list-field
    [label]="field.label"
    [placeholder]="field.placeholder || 'Sélectionnez une valeur...'"
    [required]="field.required"
    [disabled]="isPreview ? false : false"
    [externalListId]="field.externalListId"
    [displayMode]="field.externalListDisplayMode || 'select'"
    [formControl]="getFormControl()">
  </app-external-list-field>

  <!-- Configuration button (only in builder mode) -->
  <div *ngIf="!isPreview" class="field-config">
    <button mat-icon-button
            (click)="onConfigureExternalList()"
            class="config-btn"
            matTooltip="Configurer la liste externe">
      <mat-icon>settings</mat-icon>
    </button>

    <div class="external-list-info" *ngIf="field.externalListId">
      <span class="info-label">Liste:</span>
      <span class="info-value">ID {{ field.externalListId }}</span>
      <span class="info-separator">|</span>
      <span class="info-value">Mode: {{ field.externalListDisplayMode }}</span>
    </div>
  </div>
</div>
    <!-- Contact -->
    <div *ngIf="field.type === 'contact'" class="contact-field">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{field.label}} - Nom</mat-label>
        <input matInput [formControlName]="field.fieldName + '_name'" placeholder="Nom complet">
      </mat-form-field>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Téléphone</mat-label>
        <input matInput type="tel" [formControlName]="field.fieldName + '_phone'" placeholder="Numéro de téléphone">
      </mat-form-field>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Email</mat-label>
        <input matInput type="email" [formControlName]="field.fieldName + '_email'" placeholder="Adresse email">
      </mat-form-field>
    </div>

    <!-- Address -->
    <div *ngIf="field.type === 'address'" class="address-field">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>{{field.label}}</mat-label>
        <textarea matInput
                  [placeholder]="field.placeholder || 'Adresse complète'"
                  [formControlName]="field.fieldName"
                  [required]="field.required"
                  rows="3"></textarea>
      </mat-form-field>
      <div class="address-details">
        <mat-form-field appearance="outline">
          <mat-label>Code postal</mat-label>
          <input matInput [formControlName]="field.fieldName + '_zip'">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Ville</mat-label>
          <input matInput [formControlName]="field.fieldName + '_city'">
        </mat-form-field>
      </div>
    </div>

    <!-- Reference -->
    <mat-form-field appearance="outline" *ngIf="field.type === 'reference'" class="full-width">
      <mat-label>{{field.label}}</mat-label>
      <input matInput
             [placeholder]="field.placeholder || 'Référence'"
             [formControlName]="field.fieldName"
             [required]="field.required">
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </mat-form-field>

    <!-- Audio -->
    <div *ngIf="field.type === 'audio'" class="audio-field">
      <label class="field-label">{{field.label}}</label>
      <div class="audio-controls">
        <button mat-raised-button type="button">
          <mat-icon>mic</mat-icon>
          Enregistrer
        </button>
        <span *ngIf="field.required" class="required-indicator">*</span>
      </div>
    </div>

    <!-- Drawing -->
    <div *ngIf="field.type === 'drawing'" class="drawing-field">
      <label class="field-label">{{field.label}}</label>
      <div class="drawing-canvas" style="border: 1px solid #ccc; height: 200px; display: flex; align-items: center; justify-content: center;">
        <span>Zone de dessin</span>
      </div>
    </div>

    <!-- Schema -->
    <div *ngIf="field.type === 'schema'" class="schema-field">
      <label class="field-label">{{field.label}}</label>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Structure du schéma</mat-label>
        <textarea matInput
                  [formControlName]="field.fieldName"
                  [required]="field.required"
                  rows="6"
                  placeholder="Définissez votre schéma..."></textarea>
      </mat-form-field>
    </div>

    <!-- Attachment -->
    <div *ngIf="field.type === 'attachment'" class="attachment-field">
      <label class="field-label">{{field.label}}</label>
      <input type="file"
             multiple
             [formControlName]="field.fieldName"
             [required]="field.required"
             class="file-input">
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </div>

    <!-- Signature -->
    <div *ngIf="field.type === 'signature'" class="signature-field">
      <label class="field-label">{{field.label}}</label>
      <div class="signature-pad" style="border: 1px solid #ccc; height: 150px; display: flex; align-items: center; justify-content: center;">
        <span>Zone de signature</span>
      </div>
    </div>

    <!-- Barcode -->
    <div *ngIf="field.type === 'barcode'" class="barcode-field">
      <label class="field-label">{{field.label}}</label>
      <mat-form-field appearance="outline" class="full-width">
        <input matInput
               [placeholder]="field.placeholder || 'Scanner ou saisir le code'"
               [formControlName]="field.fieldName"
               [required]="field.required">
        <button mat-icon-button matSuffix type="button">
          <mat-icon>qr_code_scanner</mat-icon>
        </button>
      </mat-form-field>
    </div>

    <!-- NFC -->
    <div *ngIf="field.type === 'nfc'" class="nfc-field">
      <label class="field-label">{{field.label}}</label>
      <div class="nfc-reader" style="border: 1px solid #ccc; padding: 20px; text-align: center;">
        <mat-icon>nfc</mat-icon>
        <p>Approchez le tag NFC</p>
      </div>
    </div>

    <!-- Separator -->
    <div *ngIf="field.type === 'separator'" class="separator-field">
      <mat-divider></mat-divider>
      <span class="separator-label" *ngIf="field.label">{{field.label}}</span>
    </div>

    <!-- Table -->
    <div *ngIf="field.type === 'table'" class="table-field">
      <label class="field-label">{{field.label}}</label>
      <table mat-table class="full-width">
        <ng-container matColumnDef="col1">
          <th mat-header-cell *matHeaderCellDef>Colonne 1</th>
          <td mat-cell *matCellDef="let element">{{element.col1}}</td>
        </ng-container>
        <ng-container matColumnDef="col2">
          <th mat-header-cell *matHeaderCellDef>Colonne 2</th>
          <td mat-cell *matCellDef="let element">{{element.col2}}</td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="['col1', 'col2']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['col1', 'col2'];"></tr>
      </table>
    </div>

    <!-- Fixed Text -->
    <div *ngIf="field.type === 'fixed-text'" class="fixed-text-field">
      <div class="fixed-text-content">
        {{field.placeholder || 'Texte fixe à définir'}}
      </div>
    </div>

    <!-- Image -->
    <div *ngIf="field.type === 'image'" class="image-field">
      <label class="field-label" *ngIf="field.label">{{field.label}}</label>
      <div class="image-placeholder" style="border: 1px dashed #ccc; padding: 20px; text-align: center;">
        <mat-icon>image</mat-icon>
        <p>Image fixe à configurer</p>
      </div>
    </div>

    <!-- File Fixed -->
    <div *ngIf="field.type === 'file-fixed'" class="file-fixed-field">
      <label class="field-label">{{field.label}}</label>
      <div class="file-display" style="border: 1px solid #ccc; padding: 10px;">
        <mat-icon>description</mat-icon>
        <span>Fichier fixe à configurer</span>
      </div>
    </div>

    <!-- Calculation -->
    <div *ngIf="field.type === 'calculation'" class="calculation-field">
      <label class="field-label">{{field.label}}</label>
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Formule de calcul</mat-label>
        <input matInput
               [placeholder]="field.placeholder || 'Ex: field1 + field2'"
               [formControlName]="field.fieldName"
               readonly>
      </mat-form-field>
      <small>Résultat calculé automatiquement</small>
    </div>

    <!-- Select -->
    <mat-form-field appearance="outline" *ngIf="field.type === 'select'" class="full-width">
      <mat-label>{{field.label}}</mat-label>
      <mat-select [formControlName]="field.fieldName" [required]="field.required">
        <mat-option *ngFor="let option of safeOptions" [value]="option.value">
          {{option.label}}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </mat-form-field>

    <!-- Radio -->
    <div *ngIf="field.type === 'radio'" class="radio-group">
      <label class="field-label">{{field.label}}</label>
      <mat-radio-group [formControlName]="field.fieldName" [required]="field.required">
        <mat-radio-button *ngFor="let option of safeOptions" [value]="option.value">
          {{option.label}}
        </mat-radio-button>
      </mat-radio-group>
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </div>

    <!-- Checkbox -->
    <div *ngIf="field.type === 'checkbox'" class="checkbox-group">
      <label class="field-label">{{field.label}}</label>
      <div *ngFor="let option of safeOptions">
        <mat-checkbox [value]="option.value">
          {{option.label}}
        </mat-checkbox>
      </div>
    </div>

    <!-- File Upload -->
    <div *ngIf="field.type === 'file'" class="file-upload">
      <label class="field-label">{{field.label}}</label>
      <input type="file"
             [formControlName]="field.fieldName"
             [required]="field.required"
             class="file-input">
      <mat-error *ngIf="formGroup?.get(field.fieldName)?.hasError('required')">
        {{field.label}} is required
      </mat-error>
    </div>
  </div>
</div>
