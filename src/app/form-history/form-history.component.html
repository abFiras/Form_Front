<!-- form-history.component.html -->
<div class="history-container">
  <!-- En-tête -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <mat-icon>history</mat-icon>
        Historique des formulaires
      </h1>
      <p class="page-subtitle">
        Suivi complet de toutes les actions effectuées sur vos formulaires
      </p>
    </div>

    <div class="header-actions">
      <button mat-stroked-button (click)="toggleFilters()">
        <mat-icon>filter_list</mat-icon>
        {{ showFilters ? 'Masquer filtres' : 'Filtres avancés' }}
      </button>

      <button mat-stroked-button (click)="toggleViewMode()">
        <mat-icon>{{ viewMode === 'timeline' ? 'table_chart' : 'timeline' }}</mat-icon>
        {{ viewMode === 'timeline' ? 'Vue tableau' : 'Vue chronologique' }}
      </button>

      <button mat-raised-button color="primary" (click)="exportHistory()">
        <mat-icon>download</mat-icon>
        Exporter
      </button>
    </div>
  </div>

  <!-- Statistiques rapides -->
  <div class="stats-section" *ngIf="!statsLoading">
    <div class="stats-cards">
      <mat-card class="stat-card total">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon">timeline</mat-icon>
            <div class="stat-info">
              <div class="stat-number">{{ statistics.totalActions }}</div>
              <div class="stat-label">Total actions</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card today">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon">today</mat-icon>
            <div class="stat-info">
              <div class="stat-number">{{ statistics.todayActions }}</div>
              <div class="stat-label">Aujourd'hui</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card week">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon">date_range</mat-icon>
            <div class="stat-info">
              <div class="stat-number">{{ statistics.weekActions }}</div>
              <div class="stat-label">Cette semaine</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card month">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon">calendar_month</mat-icon>
            <div class="stat-info">
              <div class="stat-number">{{ statistics.monthActions }}</div>
              <div class="stat-label">Ce mois</div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Graphiques de statistiques -->
    <div class="charts-section">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Actions par type</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="action-stats">
            <div *ngFor="let stat of statistics.actionTypeStats" class="action-stat-item">
              <div class="stat-bar">
                <div class="stat-fill" [style.width.%]="stat.percentage" [style.background-color]="stat.color"></div>
              </div>
              <div class="stat-details">
                <span class="stat-label">{{ stat.actionTypeLabel }}</span>
                <span class="stat-count">{{ stat.count }} ({{ stat.percentage }})</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Répartition par secteur</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="secteur-stats">
            <div *ngFor="let stat of statistics.secteurStats" class="secteur-stat-item">
              <div class="secteur-info">
                <span class="secteur-name">{{ stat.secteur }}</span>
                <span class="secteur-count">{{ stat.count }} ({{ stat.percentage }})</span>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Filtres avancés -->
  <mat-card *ngIf="showFilters" class="filters-card">
    <mat-card-header>
      <mat-card-title>Filtres de recherche</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="filters-grid">
        <mat-form-field appearance="outline">
          <mat-label>Recherche globale</mat-label>
          <input matInput [(ngModel)]="filters.searchTerm" placeholder="Nom du formulaire, description...">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Nom du formulaire</mat-label>
          <input matInput [(ngModel)]="filters.formName" placeholder="Nom exact">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Secteur</mat-label>
          <input matInput [(ngModel)]="filters.secteur" placeholder="Secteur d'activité">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Type d'action</mat-label>
          <mat-select [(ngModel)]="filters.actionType">
            <mat-option *ngFor="let option of actionTypeOptions" [value]="option.value">
              {{ option.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Statut</mat-label>
          <mat-select [(ngModel)]="filters.status">
            <mat-option *ngFor="let option of statusOptions" [value]="option.value">
              {{ option.label }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Utilisateur</mat-label>
          <input matInput [(ngModel)]="filters.performedBy" placeholder="Nom d'utilisateur">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date début</mat-label>
          <input matInput [matDatepicker]="startPicker" [(ngModel)]="filters.startDate">
          <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Date fin</mat-label>
          <input matInput [matDatepicker]="endPicker" [(ngModel)]="filters.endDate">
          <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
          <mat-datepicker #endPicker></mat-datepicker>
        </mat-form-field>
      </div>

      <div class="filters-actions">
        <button mat-raised-button color="primary" (click)="applyFilters()">
          <mat-icon>search</mat-icon>
          Appliquer les filtres
        </button>
        <button mat-stroked-button (click)="resetFilters()">
          <mat-icon>clear</mat-icon>
          Réinitialiser
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Indicateur de chargement -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement de l'historique...</p>
  </div>

  <!-- Vue chronologique (Timeline) -->
  <div *ngIf="!loading && viewMode === 'timeline'" class="timeline-container">
    <div class="timeline">
      <div *ngFor="let action of historyPage.content" class="timeline-item" [class]="'action-' + action.actionType.toLowerCase()">
        <div class="timeline-marker">
          <mat-icon [style.color]="action.actionColor">{{ action.actionIcon }}</mat-icon>
        </div>

        <div class="timeline-content">
          <mat-card class="action-card" (click)="goToForm(action)">
            <mat-card-header>
              <div class="action-header">
                <div class="action-main-info">
                  <h3 class="action-title">{{ action.actionTypeLabel }}</h3>
                  <p class="form-name" (click)="goToForm(action)">{{ action.formName }}</p>
                </div>
                <div class="action-metadata">
                  <span class="action-time" [matTooltip]="action.formattedDate">{{ action.timeAgo }}</span>
                  <mat-chip [style.background-color]="getStatusColor(action.status)" class="status-chip">
                    {{ action.statusLabel }}
                  </mat-chip>
                </div>
              </div>
            </mat-card-header>

            <mat-card-content>
              <div class="action-details">
                <p class="action-description">{{ action.actionDescription }}</p>

                <div class="action-info-grid">
                  <div class="info-item">
                    <mat-icon>person</mat-icon>
                    <span>{{ action.performedByUsername }}</span>
                  </div>

                  <div class="info-item" *ngIf="action.secteur">
                    <mat-icon>business</mat-icon>
                    <span>{{ action.secteur }}</span>
                  </div>

                  <div class="info-item" *ngIf="action.fieldCount">
                    <mat-icon>description</mat-icon>
                    <span>{{ action.fieldCount }} champs</span>
                  </div>

                  <div class="info-item" *ngIf="action.isInLibrary">
                    <mat-icon style="color: #9c27b0">library_books</mat-icon>
                    <span>Dans la bibliothèque</span>
                  </div>
                </div>

                <!-- Groupes assignés -->
                <div *ngIf="action.assignedGroups && action.assignedGroups.length > 0" class="assigned-groups">
                  <span class="groups-label">Groupes:</span>
                  <mat-chip-listbox>
                    <mat-chip *ngFor="let group of action.assignedGroups" [style.background-color]="group.color">
                      {{ group.name }}
                    </mat-chip>
                  </mat-chip-listbox>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue tableau -->
  <div *ngIf="!loading && viewMode === 'table'" class="table-container">
    <mat-card>
      <table mat-table [dataSource]="historyPage.content" class="history-table">
        <!-- Colonne Date/Heure -->
        <ng-container matColumnDef="date">
          <th mat-header-cell *matHeaderCellDef>Date/Heure</th>
          <td mat-cell *matCellDef="let action">
            <div class="date-cell">
              <div class="date-time">{{ formatDate(action.createdAt) }}</div>
              <div class="time-ago">{{ action.timeAgo }}</div>
            </div>
          </td>
        </ng-container>

        <!-- Colonne Action -->
        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef>Action</th>
          <td mat-cell *matCellDef="let action">
            <div class="action-cell">
              <mat-icon [style.color]="action.actionColor">{{ action.actionIcon }}</mat-icon>
              <span>{{ action.actionTypeLabel }}</span>
            </div>
          </td>
        </ng-container>

        <!-- Colonne Formulaire -->
        <ng-container matColumnDef="form">
          <th mat-header-cell *matHeaderCellDef>Formulaire</th>
          <td mat-cell *matCellDef="let action">
            <div class="form-cell">
              <div class="form-name" (click)="goToForm(action)">{{ action.formName }}</div>
              <div class="form-secteur" *ngIf="action.secteur">{{ action.secteur }}</div>
              <mat-chip [style.background-color]="getStatusColor(action.status)" class="status-chip-small">
                {{ action.statusLabel }}
              </mat-chip>
            </div>
          </td>
        </ng-container>

        <!-- Colonne Utilisateur -->
        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef>Utilisateur</th>
          <td mat-cell *matCellDef="let action">
            <div class="user-cell">
              <mat-icon>person</mat-icon>
              <div class="user-info">
                <div class="username">{{ action.performedByUsername }}</div>
                <div class="user-email">{{ action.performedByEmail }}</div>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Colonne Description -->
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let action">
            <div class="description-cell">
              {{ action.actionDescription }}
            </div>
          </td>
        </ng-container>

        <!-- Colonne Actions -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let action">
            <div class="actions-cell">
            <!--   <button mat-icon-button (click)="viewActionDetails(action)" matTooltip="Voir détails">
                <mat-icon>visibility</mat-icon>
              </button>-->
              <button mat-icon-button (click)="goToForm(action)" matTooltip="Aller au formulaire"
                      [disabled]="action.status === 'DELETED'">
                <mat-icon>launch</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['date', 'action', 'form', 'user', 'description', 'actions']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['date', 'action', 'form', 'user', 'description', 'actions']"></tr>
      </table>
    </mat-card>
  </div>

  <!-- Pagination -->
  <mat-paginator
    *ngIf="!loading && historyPage.totalElements > 0"
    [length]="historyPage.totalElements"
    [pageSize]="pageSize"
    [pageIndex]="currentPage"
    [pageSizeOptions]="[10, 20, 50, 100]"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>

  <!-- Message si aucun résultat -->
  <div *ngIf="!loading && historyPage.content.length === 0" class="no-results">
    <mat-card class="no-results-card">
      <mat-card-content>
        <div class="no-results-content">
          <mat-icon class="no-results-icon">history_toggle_off</mat-icon>
          <h3>Aucun historique trouvé</h3>
          <p>Aucune action ne correspond à vos critères de recherche.</p>
          <button mat-raised-button color="primary" (click)="resetFilters()">
            <mat-icon>refresh</mat-icon>
            Réinitialiser les filtres
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Activité récente (sidebar) -->
  <div class="recent-activity-sidebar" *ngIf="recentActivity.length > 0">
    <h4>Activité récente (24h)</h4>
    <div class="recent-items">
      <div *ngFor="let activity of recentActivity" class="recent-item">
        <mat-icon [style.color]="activity.actionColor" class="recent-icon">{{ activity.actionIcon }}</mat-icon>
        <div class="recent-content">
          <div class="recent-action">{{ activity.actionTypeLabel }}</div>
          <div class="recent-form">{{ activity.formName }}</div>
          <div class="recent-time">{{ activity.timeAgo }}</div>
        </div>
      </div>
    </div>
  </div>
</div>
